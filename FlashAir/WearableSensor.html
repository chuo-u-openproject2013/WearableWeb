<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人気象庁 - Wearable Web</title>
    <script src="js/jquery.js"></script>
    <script src="js/btstrap.js"></script>
    <script type="text/javascript">
    /* http://tips.recatnap.info/wiki/JQuery%E3%81%A7CSV%E3%82%92%E9%85%8D%E5%88%97%E3%81%AB%E5%A4%89%E6%8F%9B_%28$.csv%28%29%29 
    * Usage:
    *  jQuery.csv()(csvtext)		returns an array of arrays representing the CSV text.
    *  jQuery.csv("\t")(tsvtext)		uses Tab as a delimiter (comma is the default)
    *  jQuery.csv("\t", "'")(tsvtext)	uses a single quote as the quote character instead of double quotes
    *  jQuery.csv("\t", "'\"")(tsvtext)	uses single & double quotes as the quote character
    *  jQuery.csv(",", "", "\n")(tsvtext)	カンマ区切りで改行コード「\n」
    */
    jQuery.extend({csv:function(c,e,f){c="string"==typeof c?RegExp("["+(c||",")+"]"):"undefined"==typeof c?",":c;e="string"==typeof e?RegExp("^["+(e||'"')+"]"):"undefined"==typeof e?'"':e;f="string"==typeof f?RegExp("["+(f||"\r\n")+"]+"):"undefined"==typeof f?"\r\n":f;return function(a){a=a.split(f);for(var b=0,m=a.length;b<m;b++){for(var n=a,p=b,g=a[b].split(c),k=[],h=void 0,d=0,l=g.length;d<l;d++)if(h=g[d].match(e)){for(j=d;j<l&&g[j].charAt(g[j].length-1)!=h[0];j++);h=g.slice(d,j+1).join(c);k.push(h.substr(1,
h.length-2));d=j}else k.push(g[d]);n[p]=k}b=a.length-1;1==a[b].length&&""==a[b][0]&&a.splice(b,1);return a}}});
    </script>
    <link href="css/btstrap.css" rel="stylesheet">
    <link href="css/btstrapr.css" rel="stylesheet">
    <style type="text/css">
    @media screen and (min-width: 768px) {
        .hero-unit{
            padding: 10px 60px 10px 160px;
        }
    }
    
    @media screen and (max-width: 767px) {
        .hero-unit{
            padding: 10px 20px 10px 20px;
        }
        .hero-unit h1{
            font-size: 40px;                                                                        
        }
    }
    
    body {
        font-size: 16px;
    }
    
    #recent-time-p {
        text-decoration: underline;
    }
    
    #recent-time {
        color: #0e90d2;
    }
    
    .div-normal{
        border: 1px solid #e5e5e5;
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 20px;
    }
    
    .table{
        font-size: 140%;
    }
    </style>
</head>
<body>
    <div class="navbar">
    <div class="navbar-inner">
        <a class="brand pull-right">Wearable Web</a>
        <ul class="nav">
            <li class="active"><a href="./">Home</a></li>
        </ul>
    </div>
    </div>
    
    <div class="container-fluid">
        
        <div class="hero-unit">
        <h1>Personal AMeDAS</h1>
	</div>
        
        <hr>
            
        <div class="row">
            <div id="message"></div>
            
            <!-- 左カラム -->
            <div class="span8">
                <div class="div-normal">
                   <h2>最新データ</h2>
                   <p id="recent-time-p">最終更新時間: <span id="recent-time"></span></p>
                   <table class="table table-bordered table-hover" id="current-data">
                   </table>
                 </div>

                <div id="raw"><pre style="height: 200px; overflow-y: scroll"></pre></div>
            </div>

            <!-- 右カラム -->
            <div class="span4">
                <div class="accordion">
                <div class="accordion-group">
                 <div class="accordion-heading">
                     <h4><a class="accordion-toggle" data-toggle="collapse" href="#collapseOne">設定</a></h4>
                 </div>
                 <div id="collapseOne" class="accordion-body collapse in">
                   <div class="accordion-inner">
                     <form id="setting-form">
                         <label class="checkbox">
                             <input type="checkbox" id="auto-reload" checked="checked">自動更新(5秒)
                         </label>
                     </form>
                   </div>
                 </div>
                </div>
                </div>
            </div>

        </div>
        
    </div>

    <script>
      var sens_num  = 1;     // センサー数
      var sens_unit = ["温度(℃)"];

    (function(){
        getData();
        
        // 自動更新
        var interval = 5000;
        setInterval( function(){
            if( $("#auto-reload").prop("checked") === true ) getData();
        }, interval);
    })();

    // データを取得                                                                           
    function getData(){
        var date = getDate();
        var filename = "DAT/" + date["year"] + date["month"] + date["day"] + ".LOG";
        
       jqXHR = $.get(filename);

       jqXHR.done( function(data, status, xhr){
           var raw = $("#raw > pre");
           raw.text(xhr.responseText);
           raw.scrollTop(raw[0].scrollHeight);

           showData(data);
       });

       jqXHR.fail( function(){
           if( $("#message .alert-error").size() === 0 ){
               $("#message").prepend('<div class="alert alert-error"><a class="close" data-dismiss="alert">×</a>データの読み込みに失敗。時間を空けて再試行してください。</div>');
           }
       });
    };                                                                           
     
     
    // 取得データを処理
    function showData(data){
        var data = $.csv()(data); // CSV to Array 
        //console.log(data);

        // 最新のデータ抽出
        var recent_data= data[data.length - 1];
        $("#recent-time").html(recent_data[0]);

        // tableに出力
        if(!$("#current-data>tbody").length){ // 最初ならタグ出力
           for(var i = 0; i < sens_num ; i++){ // センサーデータ数分
               $("#current-data").append("<tr><td>"+ sens_unit[i] + 
                   "</td><td id=\"sens-"+ i +"\">" + recent_data[i + 1] + "</td></tr>");
           }
        }else{
           for(var i = 0; i < sens_num ; i++){
               $("td#sens-" + i).html(recent_data[i + 1]);
           }
        }

    }

    // 日付取得
    function getDate(){
        var now = new Date();
        var year = now.getYear();
        var month = now.getMonth() + 1;
        var day = now.getDate();
        if (year < 2000) { year += 1900; }
        if (month < 10)  { month = "0" + month; }
        if (day   < 10)  { day   = "0" + day; }

        return {"year": year, "month": month, "day": day};
    }
    </script>
</body>
</html>

